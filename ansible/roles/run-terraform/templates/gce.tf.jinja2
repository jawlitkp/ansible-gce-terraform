provider "google" {
  credentials = "${file("{{gce_json_creds}}")}"
  project     = "{{gce_project}}"
  region      = "{{gce_region}}"
}

resource "google_compute_network" "sdsa_network" {
  name       = "{{gce_prefix}}-network"
}

resource "google_compute_subnetwork" "sdsa_subnetwork" {
  name          = "{{gce_prefix}}-subnetwork"
  ip_cidr_range = "10.1.0.0/16"
  network       = "${google_compute_network.sdsa_network.self_link}"
  region        = "{{gce_region}}"
}

resource "google_compute_disk" "persistent" {
  name  = "{{gce_prefix}}-disk"
  type  = "pd-ssd"
  zone  = "{{gce_zone}}"
  size = "50"
}

resource "google_compute_instance" "storage" {
  name         = "{{gce_prefix}}-storage"
  machine_type = "n1-standard-1"
  zone         = "{{gce_zone}}"
  tags = ["storage"]
  disk {
    image = "coreos-beta-991-2-0-v20160326"
  }
  disk {
    disk = "${google_compute_disk.persistent.name}"
    device_name = "xvdb"
  }

  network_interface {
    subnetwork = "${google_compute_subnetwork.sdsa_subnetwork.name}"
    access_config {
      # Ephemeral
    }
  }

  metadata {
    ssh-keys = "root:${file("{{gce_public_key}}")}"
    user-data = "${file("cloud-config-storage.yaml")}"
  }

  service_account {
    scopes = ["https://www.googleapis.com/auth/compute.readonly"]
  }
}

resource "google_compute_firewall" "sdsa_firewall" {
  name = "{{gce_prefix}}-firewall"
  network = "${google_compute_network.sdsa_network.name}"

  allow {
    protocol = "tcp"
    ports = ["80", "22"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags = ["storage"]
}

resource "google_dns_record_set" "sdsa_record" {
  name = "{{gce_prefix}}.{{gce_domain}}."
  type = "A"
  ttl  = 300

  managed_zone = "{{gce_dns_zone}}"

  rrdatas = ["${google_compute_instance.storage.network_interface.0.access_config.0.assigned_nat_ip}"]
}