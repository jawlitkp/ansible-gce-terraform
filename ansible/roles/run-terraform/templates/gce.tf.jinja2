provider "google" {
  credentials = "${file("{{gce_json_creds}}")}"
  project     = "{{gce_project}}"
  region      = "{{gce_region}}"
}

resource "google_compute_network" "sdsa_network" {
  name       = "{{gce_prefix}}-network"
}

resource "google_compute_subnetwork" "sdsa_subnetwork" {
  name          = "{{gce_prefix}}-subnetwork"
  ip_cidr_range = "10.1.0.0/16"
  network       = "${google_compute_network.sdsa_network.self_link}"
  region        = "{{gce_region}}"
}

resource "google_compute_http_health_check" "sdsa_healthcheck_tornado" {
  name = "{{gce_prefix}}-healthcheck-tornado"
  request_path = "/"
  check_interval_sec = 1
  healthy_threshold = 1
  unhealthy_threshold = 10
  timeout_sec = 1
}

resource "google_compute_global_forwarding_rule" "sdsa_forwarding_rule" {
  name = "{{gce_prefix}}-fwrule"
  target = "${google_compute_target_http_proxy.sdsa_httpproxy.self_link}"
  port_range = "80"
}

resource "google_compute_target_http_proxy" "sdsa_httpproxy" {
  name = "{{gce_prefix}}-proxy"
  url_map = "${google_compute_url_map.sdsa_urlmap.self_link}"
}

{% for zone in gce_zones %}
resource "google_compute_instance_group_manager" "sdsa_cmanager_tornado_{{zone}}" {
  name = "{{gce_prefix}}-cmanager-tornado-{{zone}}"
  instance_template = "${google_compute_instance_template.sdsa_template_tornado.self_link}"
  base_instance_name = "{{gce_prefix}}-tornado-{{zone}}"
  zone = "{{zone}}"

  named_port {
    name = "http"
    port = 80
  }
}

resource "google_compute_autoscaler" "sdsa_scaler_tornado_{{zone}}" {
  name = "{{gce_prefix}}-scaler-tornado-{{zone}}"
  zone = "{{zone}}"
  target = "${google_compute_instance_group_manager.sdsa_cmanager_tornado_{{zone}}.self_link}"
  autoscaling_policy = {
    max_replicas = 5
    min_replicas = 2
    cooldown_period = 60
    cpu_utilization = {
      target = 0.3
    }
  }
}

resource "google_compute_backend_service" "sdsa_service_tornado_{{zone}}" {
  name = "{{gce_prefix}}-service-tornado-{{zone}}"
  description = "Tornado based chat server"
  port_name = "http"
  protocol = "HTTP"
  timeout_sec = 10
  region = "{{gce_region}}"

  backend {
    group = "${google_compute_instance_group_manager.sdsa_cmanager_tornado_{{zone}}.instance_group}"
  }

  health_checks = ["${google_compute_http_health_check.sdsa_healthcheck_tornado.self_link}"]
}
{% endfor %}

resource "google_compute_instance" "sdsa_redis" {
  name         = "{{gce_prefix}}-redis"
  machine_type = "n1-standard-1"
  zone         = "{{gce_zones[0]}}"

  tags = ["redishost"]

  disk {
    image = "coreos-beta-991-2-0-v20160326"
  }

  network_interface {
    subnetwork = "${google_compute_subnetwork.sdsa_subnetwork.name}"
    access_config {
      # Ephemeral
    }
  }

  metadata {
    ssh-keys = "root:${file("{{gce_public_key}}")}"
    user-data = "${file("cloud-config-redis.yaml")}"
  }

  service_account {
    scopes = ["https://www.googleapis.com/auth/compute.readonly"]
  }
}

resource "template_file" "sdsa_tornado_cloudconfig" {
    template = "${file("${path.module}/cloud-config-tornado.yaml")}"

    vars {
      redis_ip = "${google_compute_instance.sdsa_redis.network_interface.0.address}"
    }
}

resource "google_compute_instance_template" "sdsa_template_tornado" {
  name = "{{gce_prefix}}-template-tornado"
  machine_type = "f1-micro"
  can_ip_forward = false
  tags = ["tornadohost"]

  disk {
    source_image = "coreos-beta-991-2-0-v20160326"
  }

  network_interface {
    subnetwork = "${google_compute_subnetwork.sdsa_subnetwork.name}"
    access_config {
      # Ephemeral
    }
  }

  metadata {
    ssh-keys = "root:${file("{{gce_public_key}}")}"
    user-data = "${template_file.sdsa_tornado_cloudconfig.rendered}"
  }

  service_account {
    scopes = ["https://www.googleapis.com/auth/compute.readonly"]
  }
}

resource "google_compute_url_map" "sdsa_urlmap" {
  name = "{{gce_prefix}}-urlmap"
  description = "az redirect"
  default_service = "${google_compute_backend_service.sdsa_service_tornado_{{gce_zones[0]}}.self_link}"

  {% for zone in gce_zones %}
  host_rule {
    hosts = ["{{loop.index}}.{{gce_domain}}"]
    path_matcher = "{{zone}}"
  }
  {% endfor %}

  {% for zone in gce_zones %}
  path_matcher {
    default_service = "${google_compute_backend_service.sdsa_service_tornado_{{zone}}.self_link}"
    name = "{{zone}}"

    path_rule {
      paths = ["/"]
      service = "${google_compute_backend_service.sdsa_service_tornado_{{zone}}.self_link}"
    }
  }
  {% endfor %}
}

resource "google_compute_firewall" "sdsa_firewall" {
  name = "{{gce_prefix}}-firewall"
  network = "${google_compute_network.sdsa_network.name}"

  allow {
    protocol = "tcp"
    ports = ["80", "22"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags = ["tornadohost", "redishost"]
}

resource "google_dns_managed_zone" "sdsa_zone" {
  name     = "{{gce_prefix}}-zone"
  dns_name = "{{gce_domain}}."
}

{% for zone in gce_zones %}
resource "google_dns_record_set" "sdsa_record_{{zone}}" {
  name = "{{loop.index}}.${google_dns_managed_zone.sdsa_zone.dns_name}"
  type = "A"
  ttl  = 300

  managed_zone = "${google_dns_managed_zone.sdsa_zone.name}"

  rrdatas = ["${google_compute_global_forwarding_rule.sdsa_forwarding_rule.ip_address}"]
}
{% endfor %}
